<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Debugging Kernel with separate image and initramfs</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-interactiveBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="2fcb5866-1fe9-4c54-a02c-a30b4230e7db" class="page sans"><header><h1 class="page-title">Debugging Kernel with separate image and initramfs</h1><p class="page-description"></p></header><div class="page-body"><nav id="740cee4a-486a-4140-9fe4-fa859c12695c" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#c96a0240-e0d3-4d00-a687-b07a9c700fff">Kernel Preparation</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#5475a5e0-b9ea-4f81-a2ba-cd209e0eba50">Creating initramfs</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#ab4558f9-9720-4575-b111-f5d80f1828d8">Filesystem Preparation</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#b955a536-145b-490f-a600-fe76b935c7b9">Virtme</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0811ce39-cdf6-4fb6-8f8d-58af9a6bbe22">x86_64/amd64</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#62132bc2-35e0-4115-bcdd-0f51a39d0168">aarch64</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#a5f7c74e-473f-4be7-8dc4-10b104fb8bbc">Qemu</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#05c8f7ed-fdc0-4f59-83f2-51fd149c6e98">Cloud image</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#06422132-fb80-40f9-9811-1c5e174dad43">Custom disk-image</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#b878ebf5-3e5b-46c1-a1cb-ca20fe5e1976">Vagrant</a></div></nav><p id="3c5d84e8-2e7f-4313-aa1e-61952db6500e" class="">If making a kernel without signed modules and generally Y options for modules, then this copypasta doesn’t cover those cases. This is strictly for kernels where there’s an expectation of a separate kernel image and separated signed-modules image.</p><h2 id="c96a0240-e0d3-4d00-a687-b07a9c700fff" class="">Kernel Preparation</h2><p id="2640270e-7e9e-4636-9efd-b4676e5c88e3" class="">Shallow-clone a kernel:</p><pre id="cd19b7ed-7518-4f59-abe9-95d373923e07" class="code"><code>$ git clone \
	--depth 1 \
	--origin stable \
	--branch v6.1.34 \
	git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git \
	stable-6.1.34  </code></pre><p id="1aa77f62-dcec-4e33-9b5a-2c8d00dda895" class="">Configure default kernel:</p><pre id="0859b229-3b97-4a88-88e9-bb90bb460b45" class="code"><code>$ cd stable-6.1.34
# for x86_64
$ make defconfig
# for aarch64
$ sudo apt install gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu gcc-multiarch
$ make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig</code></pre><p id="41270fa0-bb3e-4474-abd5-a7e1b7fb825f" class="">Configure kernel to sign modules, require signature verification, and then modualize useful modules for virtualization:</p><pre id="77c7e1e4-ffb7-44e8-86f8-7158113bd974" class="code"><code>$ ./scripts/config \
	--set-str LOCALVERSION &quot;-experiment&quot; \
	-d LOCALVERSION_AUTO \
	-e MODULE_SIG_FORMAT \
	-e MODVERSIONS \
	-e ASM_MODVERSIONS \
	-e MODULE_SIG \
	-e MODULE_SIG_FORCE \
	-e MODULE_SIG_ALL \
	-d MODULE_SIG_SHA1 \
	-e MODULE_SIG_SHA256 \
	-d MODULE_SIG_SHA224 \
	-d MODULE_SIG_SHA384 \
	-d MODULE_SIG_SHA512 \
	--set-str MODULE_SIG_HASH &quot;sha256&quot; \
	-m NET_9P \
	-m NET_9P_FD \
	-m NET_9P_VIRTIO \
	-m SCSI_VIRTIO \
	-m VIRTIO_PCI_LIB \
	-m VIRTIO_PCI_LIB_LEGACY \
	-m VIRTIO_PCI \
	-m NETFS_SUPPORT \
	-m 9P_FS \
	-e SECURITY_LOCKDOWN_LSM \
	-d LOCK_DOWN_KERNEL_FORCE_NONE \
	-d SECURITY_LOCKDOWN_LSM_EARLY \
	-e LOCK_DOWN_KERNEL_FORCE_INTEGRITY \
	-d LOCK_DOWN_KERNEL_FORCE_CONFIDENTIALITY \
	--set-str MODULE_SIG_KEY &quot;certs/signing_key.pem&quot; \
	-e MODULE_SIG_KEY_TYPE_RSA \
	-d MODULE_SIG_KEY_TYPE_ECDSA</code></pre><p id="7da8fc22-6e24-473e-8d2f-e16ab293c02b" class="">Build the kernel:</p><pre id="ca536263-9bc9-4ea6-b239-8fe580238c8a" class="code"><code># for x86_64
$ make -j$(nproc)
# for aarch64
$ make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)</code></pre><h3 id="5475a5e0-b9ea-4f81-a2ba-cd209e0eba50" class="">Creating initramfs</h3><p id="1d6df6de-a589-421b-9470-49a0730deb10" class="">With the image created, we need to install modules. Normally we’d install these onto the systems file system (see Qemu and Vagrant sections), but in our case, we need to create a file system. This will sign and then install modules into this directory.</p><pre id="33e0459b-f923-4f43-ba14-5b131e1083d7" class="code"><code>$ ARCH=x86_64 export INITRAMFS=initramfs-modules-6.1.34-experiment-$ARCH
$ mkdir -p /tmp/$INITRAMFS
$ make INSTALL_MOD_PATH=/tmp/$INITRAMFS modules_install</code></pre><p id="c7fa9c68-c7da-48ba-b149-8ecb40ccaec4" class="">With modules installed, we need to package them into a cpio image.</p><pre id="8d00fd14-9810-46e8-a8d5-e2beda7bd2b8" class="code"><code>$ $(cd /tmp/$INITRAMFS &amp;&amp; find . | sudo cpio -o --verbose --format=newc &gt; ../$INITRAMFS.img)
$ mv /tmp/$INITRAMFS.img .</code></pre><p id="f0baaaf6-2ca3-4ee1-b265-a6c744140983" class="">Verify everything is correct:</p><pre id="ef43e04f-a414-44c1-8b3d-5c08236891dc" class="code"><code>$ lsinitramfs $INITRAMFS.img</code></pre><h2 id="ab4558f9-9720-4575-b111-f5d80f1828d8" class="">Filesystem Preparation</h2><pre id="d6cee9c9-2ce0-4de2-9058-90327a33cf38" class="code"><code># for x86_64
$ mkdir -p ~/filesystems/bullseye-amd64
$ sudo debootstrap --include=busybox-static bullseye ~/filesystems/bullseye-arm64 http://deb.debian.org/debian
# for arm64
$ mkdir -p ~/filesystems/bullseye-arm64
$ sudo debootstrap --arch=arm64 --include=busybox-static,python3 bullseye ~/filesystems/bullseye-arm64 http://deb.debian.org/debian</code></pre><h2 id="b955a536-145b-490f-a600-fe76b935c7b9" class="">Virtme</h2><p id="dabc1c0d-d46d-45b4-9d9d-c7e3a50cbd09" class="">Install qemu: 
Install virtme: <a href="https://github.com/amluto/virtme#how-to-use-virtme">https://github.com/amluto/virtme#how-to-use-virtme</a></p><ul id="559ac961-fbf7-48e4-ae24-9b478eb820ed" class="bulleted-list"><li style="list-style-type:disc">Skip kernel configuration</li></ul><h3 id="0811ce39-cdf6-4fb6-8f8d-58af9a6bbe22" class="">x86_64/amd64</h3><p id="d6bba198-21d2-4e11-85e4-80067f2982bb" class="">Create a virtme initramfs:</p><pre id="c13835a1-f0cb-481b-ab3c-b8dab6554e05" class="code"><code>$ virtme-mkinitramfs --rw --mod-kversion 6.1.34-experiment --outfile initramfs-virtme.img</code></pre><p id="2a26b7f1-247e-412b-a76a-1d37991a2bbd" class="">Qemu doesn’t support multiple <code>-initrd</code> AFAIK, so we need to combine our two initramfs:</p><pre id="7e0deee3-b636-433d-a346-8c4fe512745a" class="code"><code>$ cat $INITRAMFS.img initramfs-virtme.img &gt; initramfs-merged.img</code></pre><p id="e1093785-ba32-403d-88a6-747d8b153eed" class="">To run with host file system:</p><pre id="4065570f-7a77-4d99-bec3-529fcb76884f" class="code"><code>$ virtme-run \
	--kimg arch/x86_64/boot/bzImage \  
	--memory 4G \ 
	--rw \
	--qemu-opts \
	-initrd initramfs-merged.img \
	-enable-kvm \ 
	-cpu host</code></pre><p id="a9900d69-f8a5-4e5a-a9cf-ef3eada29901" class="">A custom file system is necessary for aarch64, but optional for x86_64/amd64:</p><pre id="006839ee-4171-4fdb-aae1-39fe37acda34" class="code"><code>$ virtme-run \
	--root ~/filesystems/bullseye-amd64 \
	--kimg arch/x86_64/boot/bzImage \  
	--memory 4G \ 
	--rw \
	--qemu-opts \
	-initrd initramfs-merged.img \
	-enable-kvm \ 
	-cpu host</code></pre><h3 id="62132bc2-35e0-4115-bcdd-0f51a39d0168" class="">aarch64</h3><p id="6a42c4c2-e7af-406b-9e6d-396da08b0d65" class="">// TODO: As I thought, the virtme-mkinitramfs doesn’t support multi-arch—upstream opportunity? — that is, make the python script chroot into the arm env and then make initramfs from there or cross compile busybox and setup the initramfs that way</p><p id="013e52df-ced5-41e1-9102-60267d16c3a9" class="">// TODO: one possible idea is unarchiving the mods to .virtme_mods — since virtme does mkinitramfs anyway, it’s possible this may work.</p><p id="0a965c9a-1d3b-4334-8ab3-02c97c9f048c" class="">// TODO: have a docker container with busybox-static &amp; virtme to make a initramfs there, and then combine with the modules</p><pre id="02498d52-6994-49b0-84e3-adc0b161431b" class="code"><code>$ sudo cp -r $(dirname $(which virtme-mkinitramfs)) ~/filesystems/bullseye-arm64/opt
$ sudo chroot ~/filesystems/bullseye-arm64
$ cd /opt/virtme/ &amp;&amp; ./virtme-mkinitramfs --rw --mod-kversion 6.1.34-experiment --outfile initramfs-virtme.img
$ exit
$ cp ~/filesystems/bullseye-arm64/opt/virtme/initramfs-virtme.img .
$ virtme-run \
	--arch aarch64 \
	--root ~/filesystems/bullseye-arm64 \
	--kimg ./arch/arm64/boot/Image \
	--memory 4G \ 
	--rw \
	--qemu-opts \
	-initrd initramfs-merged.img</code></pre><h2 id="a5f7c74e-473f-4be7-8dc4-10b104fb8bbc" class="">Qemu</h2><pre id="ad065f8b-26b9-4594-8c95-e421fa9632f0" class="code"><code>$ sudo apt install libguestfs-tools
# x86_64/amd64
$ make -j$(nproc) deb-pkg
# aarch64
$ sudo apt install qemu-system-aarch64 qemu-efi-aarch64
$ make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) deb-pkg
</code></pre><blockquote id="fd8e487d-6cea-4ea9-bfcc-5b5eec6d5c32" class="">Take note of the ../*.deb package names, they could be different.</blockquote><h3 id="05c8f7ed-fdc0-4f59-83f2-51fd149c6e98" class="">Cloud image</h3><p id="e4588410-3471-4624-b038-2cd52940622a" class="">aarch64:</p><pre id="ad01f333-33a7-4b44-84f8-5f36328323a0" class="code"><code>$ $(cd ~/filesystems &amp;&amp; wget https://cloud.debian.org/images/cloud/bullseye/20230601-1398/debian-11-genericcloud-arm64-20230601-1398.raw)
$ virt-customize -a ~/filesystems/debian-11-genericcloud-arm64-20230601-1398.raw --root-password password:password
$ dd if=/dev/zero of=/home/$(whoami)/filesystems/efi.img bs=1M count=64
$ dd if=/usr/share/qemu-efi-aarch64/QEMU_EFI.fd of=/home/$(whoami)/filesystems/efi.img conv=notrunc
$ mkdir -p /tmp/debian-11-generic-arm64
$ sudo guestmount -a /home/$(whoami)/filesystems/debian-11-genericcloud-arm64-20230601-1398.raw -i --rw /tmp/debian-11-generic-arm64
$ sudo cp ../linux-image-6.1.34-experiment_6.1.34-experiment-5_arm64.deb /tmp/debian-11-generic-arm64/root
$ sudo guestunmount /tmp/debian-11-generic-arm64
$ qemu-system-aarch64 \
		-nographic \
		-machine virt \
		-m 8G \
		-cpu max \
		-smp 8 \
		-drive file=/home/$(whoami)/filesystems/efi.img,format=raw,if=pflash \
		-drive file=/home/$(whoami)/filesystems/debian-11-genericcloud-arm64-20230601-1398.raw,id=drive0,format=raw,if=virtio
# once in the VM
$ dpkg -i linux-image-6.1.34-experiment_6.1.34-experiment-5_arm64.deb
$ ctl + a + c
(qemu) quit
$ ... rerun qemu to boot into new kernel</code></pre><h3 id="06422132-fb80-40f9-9811-1c5e174dad43" class="">Custom disk-image</h3><p id="8d47b775-60bb-424b-9981-a36365cbbaf0" class="">// TODO: Basically follow same section as above, but leverage <code>debootstrap</code> to create the FS, and then <code>qemu-img</code> to convert to a image for use.</p><h2 id="b878ebf5-3e5b-46c1-a1cb-ca20fe5e1976" class="">Vagrant</h2><p id="2de00687-82a4-4bb4-bb6c-9cd787dc0b7f" class="">// TODO: Not sure how this will work. May work exactly like qemu, but instead of mounting disks etc… you can just copy the .deb to the guest from the host and run <code>dpkg -i *.deb</code> and reboot, and that should work.</p></div></article></body></html>